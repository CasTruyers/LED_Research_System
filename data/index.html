<html>

<head>
    <title>ESP32 Web Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <style>
        html {
            font-family: New Times Roman;
            text-align: center;
        }

        h1 {
            font-size: 1.8rem;
            color: white;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #07156d;
        }

        .card {
            background-color: #F8F7F9;
            ;
            box-shadow: 2px 2px 12px 1px rgba(140, 140, 140, .5);
            padding-top: 10px;
            padding-bottom: 20px;
        }

        .topnav {
            overflow: hidden;
            background-color: #04296d;
        }

        body {
            margin: 0;
        }

        .content {
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
        }

        .slider-container {
            width: 80%;
            margin: 0 auto;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 25px;
            border-radius: 5px;
            background-color: #f0f0f0;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #0ffa6d;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #0ffa6d;
            cursor: pointer;
        }

        .state {
            font-size: 1.5rem;
            color: #120707;
            font-weight: bold;
        }

        .info-box {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin-top: 20px;
    }
    </style>
    <title>ESP32 Web Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
</head>

<body>
    <div class="topnav">
        <h1>LED-SYSTEM</h1>
    </div>
    <div class="content">
        <div class="card">
            <h2>Duty-Cycle</h2>
            <div class="slider-container">
                <label for="slider1">FAR RED</label>
                <input type="range" id="slider1" class="slider" min="0" max="255" value="0">
                <label for="slider1">DEEP RED</label>
                <input type="range" id="slider2" class="slider" min="0" max="255" value="0">
                <label for="slider1">WHITE</label>
                <input type="range" id="slider3" class="slider" min="0" max="255" value="0">
                <label for="slider1">ROYAL BLUE</label>
                <input type="range" id="slider4" class="slider" min="0" max="255" value="0">
            </div>
            <p class="state">Values: <span id="values">0, 0, 0, 0</span></p>
        </div>
        <div class="info-box">
            <h3>System Information</h3>
            <p><strong>Temperature:</strong> 23&deg;C</p>
            <p><strong>Humidity:</strong> 63%</p>
            <br>
            <p><strong>Total PPF:</strong> <span id="total-ppf">0</span> uMol/s</p>
            <p><strong>Far Red (720-740nm) PPF:</strong> <span id="far-red-ppf">0</span> uMol/s, resistor: 6800 Ohms, max current: 300, estimated current: 160 mA, calculated current: </p>
            <p><strong>Deep Red (650-670nm) PPF:</strong> <span id="deep-red-ppf">0</span> uMol/s, resistor: 6800 Ohms, max current: 250, estimated current: 160 mA, calculated current: </p>
            <p><strong>White (full spectrum) PPF:</strong> <span id="white-ppf">0</span> uMol/s, resistor: 6800 Ohms, max current: 480, estimated current: 160 mA, calculated current: </p>
            <p><strong>Royal Blue (440-455nm) PPF:</strong> <span id="royal-blue-ppf">0</span> uMol/s, resistor: 6800 Ohms, mac current: 240, estimated current: 160 mA, calculated current: </p>
            <br>
            <p><label for="on-time">On time:</label>
            <input type="text" id="on-time" name="on-time" placeholder="hh:mm"></p>
            <p><label for="off-time">Off time:</label>
            <input type="text" id="off-time" name="off-time" placeholder="hh:mm"></p>
            <p><button onclick="saveTimes()">Save</button></p>
        </div>
    </div>
    </div>
    <script>
        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;
        var sliders = [
            document.getElementById('slider1'),
            document.getElementById('slider2'),
            document.getElementById('slider3'),
            document.getElementById('slider4')
        ];
        var valuesSpan = document.getElementById('values');
        window.addEventListener('load', onLoad);

        let payload = {
            action: "",
            drivers: {
                firstDriver: {
                    dutyCycle: "0"
                },
                secondDriver: {
                    dutyCycle: "0"
                },
                thirdDriver: {
                    dutyCycle: "0"
                },
                fourthDriver: {
                    dutyCycle: "0"
                },
            },
            setTime: {
                onTime: "",
                offTime: ""
            }
        };

        function initWebSocket() {
            console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = function (event) {
                console.log('WebSocket connection opened:', event);
            };
            websocket.onmessage = function(event) {
                onMessage(event);
            };
                
            websocket.onclose = function (event) {
                console.log('WebSocket connection closed:', event);
                setTimeout(initWebSocket, 2000);
            };
        }

        function updateSliderText()
        {
            valuesSpan.textContent = sliders.map(function (slider) {
                return slider.value;
            }).join(', ');
        }

        function onMessage()
        {
            console.log('WebSocket message received:', event);
            const jsonObj = JSON.parse(event.data);
            if(jsonObj.action == "dutyCycle")
            {
                const driversJson = jsonObj.drivers;
                payload.drivers.firstDriver.dutyCycle = driversJson.firstDriver.dutyCycle
                payload.drivers.secondDriver.dutyCycle = driversJson.secondDriver.dutyCycle
                payload.drivers.thirdDriver.dutyCycle = driversJson.thirdDriver.dutyCycle
                payload.drivers.fourthDriver.dutyCycle = driversJson.fourthDriver.dutyCycle
                
                sliders[0].value = payload.drivers.firstDriver.dutyCycle;
                sliders[1].value = payload.drivers.secondDriver.dutyCycle;
                sliders[2].value = payload.drivers.thirdDriver.dutyCycle;
                sliders[3].value = payload.drivers.fourthDriver.dutyCycle;
                updateSliderText();
            }
            else if(jsonObj.action == "setTime")
            {
                //add code
            }
            else console.log("unknown action: ", jsonObj.action);
        }

        function onLoad() {
            for (var i = 0; i < sliders.length; i++) {
                sliders[i].addEventListener('change', onSliderChange.bind(null, i));
            }
            initWebSocket();
            
        }

        function onSliderChange(sliderNum) {
            updateSliderText();
            sendSliderValue(sliderNum);
            calculatePPF();
        }

        function sendSliderValue(sliderNum) {
            //Fill in JSON and send to ESP32 over websocket
            if (websocket.readyState === WebSocket.OPEN) {
                payload.action = "dutyCycle";
                payload.drivers.firstDriver.dutyCycle = sliders[0].value;
                payload.drivers.secondDriver.dutyCycle = sliders[1].value;
                payload.drivers.thirdDriver.dutyCycle = sliders[2].value;
                payload.drivers.fourthDriver.dutyCycle = sliders[3].value;
                websocket.send(JSON.stringify(payload));
            }
        }

        function calculatePPF() {
            var farRed = sliders[0].value;
            var deepRed = sliders[1].value;
            var white = sliders[2].value;
            var royalBlue = sliders[3].value;
            
            //Function to fine tune PPF estimation
            var farRedPPF = farRed;
            var deepRedPPF = deepRed;
            var whitePPF = white;
            var royalBluePPF = royalBlue;
            const totalPPF = parseInt(farRedPPF) + parseInt(deepRedPPF) + parseInt(whitePPF) + parseInt(royalBluePPF);

            var farRedPPFElement = document.querySelector("#far-red-ppf");
            farRedPPFElement.textContent = farRedPPF;

            var deepRedPPFElement = document.querySelector("#deep-red-ppf");
            deepRedPPFElement.textContent = deepRedPPF;

            var whitePPFElement = document.querySelector("#white-ppf");
            whitePPFElement.textContent = whitePPF;

            var royalBluePPFElement = document.querySelector("#royal-blue-ppf");
            royalBluePPFElement.textContent = royalBluePPF;

            var totalPPFElement = document.querySelector("#total-ppf");
            totalPPFElement.textContent = totalPPF;
        }

        function saveTimes() {
            // get the values of the on/off time input fields
            const onTime = document.getElementById('on-time').value;
            const offTime = document.getElementById('off-time').value;

            // send the on/off times to the ESP32 over WebSocket
            sendTimesToEsp32(onTime, offTime);
        }

        function sendTimesToEsp32(onTime, offTime) {
            //Fill in JSON and send to ESP32 over websocket
            if (websocket.readyState === WebSocket.OPEN) {
                payload.action = "setTime";
                payload.setTime.onTime = onTime;
                payload.setTime.offTime = offTime;
                websocket.send(JSON.stringify(payload));
            };
        }

    </script>
</body>

</html>